(()=>{"use strict";var e={379:function(e,t,a){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.LocalDatabase=void 0;const n=s(a(689));function r(){return(new Date).toISOString()}function o(e){return e?1:0}t.LocalDatabase=class{_DataBaseFile;_DataBase;constructor(e){this._DataBaseFile=e,this._DataBase=new n.default.Database(this._DataBaseFile)}CreateDBStruct(){this._DataBase.serialize((()=>{this._DataBase.run("CREATE TABLE Tarea (\n\t\t\tID         INTEGER     PRIMARY KEY \n\t\t\t\t\t\t\t\t   NOT NULL,\n\t\t\tTexto      TEXT        NOT NULL,\n\t\t\tFecha      NUMERIC     NOT NULL,\n\t\t\tCompletada INTEGER (2) NOT NULL\n\t\t);"),this._DataBase.run("CREATE TABLE Estado (\n        Tarea              REFERENCES Tarea (ID) ON DELETE CASCADE ON UPDATE CASCADE NOT NULL,\n        Fecha              NUMERIC NOT NULL,\n        Estado             INTEGER NOT NULL,\n        PRIMARY KEY (Tarea, Fecha)\n    );"),this._DataBase.run("CREATE TRIGGER actualizar_completada\n    AFTER INSERT ON Estado\n    BEGIN\n        UPDATE Tarea\n        SET Completada = NEW.Estado\n        WHERE ID = NEW.Tarea;\n    END;")}))}async _GetNextIdInter(){return new Promise(((e,t)=>{this._DataBase.get("select id from Tarea ORDER BY id DESC limit 1",((a,s)=>{a&&t(a),e(s||void 0)}))}))}async _GetNextId(){let e=await this._GetNextIdInter();return null==e||"object"==typeof e&&e.constructor===Object?1:e.ID+1}async _CrearTarea(e,t,a){this._DataBase.run("INSERT INTO Tarea (Completada,Fecha,Texto,ID)VALUES (?,?,?,?);",[o(a),r(),t,e])}async _NewEstado(e,t){console.log(o(t)),this._DataBase.run("INSERT INTO Estado (Estado,Fecha,Tarea) VALUES (?,?,?);",[o(t),r(),e])}async _UpdateText(e,t){this._DataBase.run("UPDATE Tarea\n    SET Texto = ?       \n  WHERE ID = ?;",[t,e])}async GetAllTaskInter(){return new Promise(((e,t)=>{this._DataBase.all("SELECT t.id, t.Texto, COALESCE(e.Fecha, t.Fecha) AS Fecha,COALESCE(e.estado, 0) AS completado FROM tarea t LEFT JOIN (SELECT tarea, estado, fecha FROM estado e1 WHERE fecha = (SELECT MAX(fecha) FROM estado e2 WHERE e1.tarea = e2.tarea)) e ON t.id = e.tarea;",((a,s)=>{a&&t(a),e(s)}))}))}async _GetAllTask(){let e=await this.GetAllTaskInter();return null==e?[]:e}async _deleteTask(e){this._DataBase.run("DELETE FROM Tarea WHERE ID = ?",[e])}}},265:function(e,t,a){var s=this&&this.__createBinding||(Object.create?function(e,t,a,s){void 0===s&&(s=a);var n=Object.getOwnPropertyDescriptor(t,a);n&&!("get"in n?!t.__esModule:n.writable||n.configurable)||(n={enumerable:!0,get:function(){return t[a]}}),Object.defineProperty(e,s,n)}:function(e,t,a,s){void 0===s&&(s=a),e[s]=t[a]}),n=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),r=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var a in e)"default"!==a&&Object.prototype.hasOwnProperty.call(e,a)&&s(t,e,a);return n(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.activate=void 0;const o=r(a(398)),i=r(a(896)),c=r(a(928)),l=r(a(379));t.activate=async function(e){const t=new u(e.extensionUri);e.subscriptions.push(o.commands.registerCommand("StartTaskDB",(async()=>{let[e,a]=function(e){let t=!1;const a=e.workspaceFolders;if(!a||0===a.length)return["",!1];const s=a[0].uri.fsPath,n=c.join(s,".vscode");(function(e){try{return i.lstatSync(e).isDirectory()}catch(e){return!1}})(n)||i.mkdirSync(n);const r=c.join(s,".vscode","Task.sqlite3");return i.existsSync(r)||(i.closeSync(i.openSync(r,"w")),t=!0),[r,t]}(o.workspace);if(""!=e){const s=new l.LocalDatabase(e);a&&s.CreateDBStruct();let n=await s._GetAllTask(),r=t.getView();if(void 0!==r){r.webview.postMessage({type:"GetAll",Tareas:n});let e=await s._GetNextId();r.webview.postMessage({type:"GetNextID",ID:e})}}}))),e.subscriptions.push(o.commands.registerCommand("AddTaskToDB",(async(e,a,s)=>{const n=new l.LocalDatabase(d(o.workspace));await n._CrearTarea(e,a,s);let r=await n._GetNextId(),i=t.getView();void 0!==i&&i.webview.postMessage({type:"GetNextID",ID:r})}))),e.subscriptions.push(o.commands.registerCommand("UpdateTextTaskToDB",(async(e,t)=>{const a=new l.LocalDatabase(d(o.workspace));await a._UpdateText(e,t)}))),e.subscriptions.push(o.commands.registerCommand("UpdateStatusTaskToDB",(async(e,t)=>{const a=new l.LocalDatabase(d(o.workspace));await a._NewEstado(e,t)}))),e.subscriptions.push(o.commands.registerCommand("DeleteTaskToDB",(async e=>{const t=new l.LocalDatabase(d(o.workspace));await t._deleteTask(e)}))),e.subscriptions.push(o.commands.registerCommand("GetNextIDTaskOfDB",(async()=>{const e=new l.LocalDatabase(d(o.workspace));let a=await e._GetNextId(),s=t.getView();void 0!==s&&s.webview.postMessage({type:"GetNextID",ID:a})}))),e.subscriptions.push(o.commands.registerCommand("GetAllTasksOfDB",(async()=>{const e=new l.LocalDatabase(d(o.workspace));let a=await e._GetAllTask(),s=t.getView();void 0!==s&&s.webview.postMessage({type:"GetAll",Tareas:a})}))),e.subscriptions.push(o.window.registerWebviewViewProvider(u.viewType,t))};class u{_extensionUri;static viewType="MyTasksView";_view;constructor(e){this._extensionUri=e}resolveWebviewView(e,t,a){this._view=e,e.webview.options={enableScripts:!0,localResourceRoots:[this._extensionUri]},e.webview.html=this._getHtmlForWebview("sidebar.html","style.css","main.js"),e.webview.onDidReceiveMessage((e=>{switch(e.type){case"StartTaskDB":case"GetAllTasksOfDB":o.commands.executeCommand(e.type);break;case"AddTaskToDB":o.commands.executeCommand(e.type,e.ID,e.Text,e.Status);break;case"UpdateTextTaskToDB":o.commands.executeCommand(e.type,e.ID,e.Text);break;case"UpdateStatusTaskToDB":o.commands.executeCommand(e.type,e.ID,e.Status);break;case"DeleteTaskToDB":case"GetNextIDTaskOfDB":o.commands.executeCommand(e.type,e.ID)}}))}_getHtmlForWebview(e,t,a){const s=o.Uri.joinPath(this._extensionUri,"resources","css",t),n=o.Uri.joinPath(this._extensionUri,"resources","templates",e),r=o.Uri.joinPath(this._extensionUri,"resources","js",a),c=i.readFileSync(r.fsPath,"utf8"),l=i.readFileSync(n.fsPath,"utf8");return`\n\t\t<style>${i.readFileSync(s.fsPath,"utf8")}</style>\n\n\t\t${l}\n\n\t\t<script>${c}<\/script>\n\t\t`}getView(){return this._view}}function d(e){const t=e.workspaceFolders;if(!t||0===t.length)return"";const a=t[0].uri.fsPath;return c.join(a,".vscode","Task.sqlite3")}},689:e=>{e.exports=require("sqlite3")},398:e=>{e.exports=require("vscode")},896:e=>{e.exports=require("fs")},928:e=>{e.exports=require("path")}},t={},a=function a(s){var n=t[s];if(void 0!==n)return n.exports;var r=t[s]={exports:{}};return e[s].call(r.exports,r,r.exports,a),r.exports}(265);module.exports=a})();